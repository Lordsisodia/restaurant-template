# Reviews Page - BMAD Architecture Plan

**Status:** Planning → Implementation
**Owner:** Development Team
**Created:** 2025-10-26
**Domain:** Reviews (`src/domains/customer-facing/reviews`)

---

## 🎯 Overview

The Reviews page is a critical social proof component that displays customer testimonials, ratings, and feedback. It must support filtering, sorting, authenticated review submission, and multiple display templates.

---

## 📋 Business Requirements

### User Goals
1. **Browse Reviews** - Quickly scan authentic customer experiences
2. **Filter & Sort** - Find relevant reviews (by rating, date, source, features)
3. **Trust Signals** - See verified reviews, ratings distribution, featured tags
4. **Submit Reviews** - Authenticated users can leave feedback
5. **Helpful Votes** - Mark reviews as helpful

### Key Metrics
- Review conversion rate (views → submissions)
- Average rating visibility
- Time to find relevant review
- Mobile interaction success rate

---

## 🏗️ Architecture Overview

Following the established domain-based architecture pattern used in other domains (specials, landing):

```
src/domains/customer-facing/reviews/
├── pages/
│   ├── ReviewsPage.tsx           # Main customer-facing page (template-based)
│   └── AdminReviewsPage.tsx      # Admin management (future)
│
├── templates/
│   ├── template-1/               # Grid layout with sidebar filters
│   │   ├── index.tsx
│   │   ├── components/
│   │   │   ├── ReviewCard.tsx
│   │   │   ├── RatingsSummary.tsx
│   │   │   ├── FilterBar.tsx
│   │   │   └── ReviewsGrid.tsx
│   │   ├── hooks/
│   │   │   ├── useReviewFilters.ts
│   │   │   └── useReviewSubmission.ts
│   │   └── utils/
│   │       └── reviewHelpers.ts
│   │
│   ├── template-2/               # Masonry layout (future)
│   ├── template-3/               # Carousel cards (future)
│   ├── ReviewsHost.tsx           # Template selector/router
│   └── types.ts                  # Shared template types
│
├── components/
│   ├── AddReviewModal.tsx        # Shared review submission
│   ├── StarRating.tsx            # Shared rating component
│   └── VerifiedBadge.tsx         # Shared verification badge
│
├── hooks/
│   └── useReviewAnalytics.ts     # Shared analytics tracking
│
├── actions.ts                    # Server actions (filters, submission)
├── ReviewsPageClient.tsx         # Client wrapper for interactivity
├── index.ts                      # Public exports
└── README.md                     # Domain documentation
```

---

## 🎨 Component Breakdown

### 1. **ReviewsPage** (pages/ReviewsPage.tsx)
**Type:** Server Component
**Purpose:** Data fetching and template routing
**Responsibilities:**
- Fetch tenant configuration
- Load reviews data
- Determine template variant from config
- Pass data to ReviewsHost

```typescript
interface ReviewsPageProps {
  searchParams?: Promise<{
    rating?: string;
    source?: string;
    feature?: string;
    sort?: string;
  }>;
}
```

### 2. **ReviewsHost** (templates/ReviewsHost.tsx)
**Type:** Server Component
**Purpose:** Template selection and routing
**Responsibilities:**
- Route to correct template based on variant
- Pass standardized props to templates
- Handle template not found scenarios

```typescript
interface ReviewsHostProps {
  variant: ReviewsVariant;
  reviews: Review[];
  tenant: {
    displayName: string;
    slug: string;
  };
}

type ReviewsVariant = 'template-1' | 'template-2' | 'template-3';
```

### 3. **Template-1** (templates/template-1/index.tsx)
**Type:** Server Component
**Purpose:** Grid layout with sidebar filters
**Features:**
- Two-column layout (filters sidebar + reviews grid)
- Sticky filters on desktop
- Mobile-first responsive design
- Rating distribution chart
- Featured tags display

**Sub-components:**

#### **RatingsSummary**
- Overall rating display (avg + total count)
- Star rating breakdown (5★ → 1★ with bars)
- Featured tags (e.g., "Great Service", "Delicious Food")

#### **FilterBar**
- Rating filter (All, 5★, 4★, 3★, 2★, 1★)
- Source filter (All, Google, TripAdvisor, Direct)
- Feature filter (All, Photo Reviews, Verified, Recent)
- Sort dropdown (Newest, Highest Rated, Most Helpful)

#### **ReviewsGrid**
- Responsive grid (1 col mobile, 2 cols desktop)
- Infinite scroll or pagination
- Empty state handling

#### **ReviewCard**
- Reviewer name + verified badge
- Star rating + date
- Review text (truncated with "Read more")
- Photos (if available)
- Source badge (Google/TripAdvisor)
- Helpful button + count
- Admin reply (if exists)

### 4. **ReviewsPageClient** (ReviewsPageClient.tsx)
**Type:** Client Component
**Purpose:** Handle client-side interactivity
**Responsibilities:**
- Manage "Write Review" modal state
- Handle review submission
- Handle "Helpful" vote increments
- Provide client-side context to server components

### 5. **AddReviewModal** (components/AddReviewModal.tsx)
**Type:** Client Component
**Purpose:** Review submission form
**Features:**
- Star rating selector
- Text area with character limit
- Photo upload (optional)
- Anonymous/named toggle
- Form validation
- Success/error states

---

## 🔧 Hooks & Utilities

### Hooks

#### **useReviewFilters** (template-1/hooks/)
```typescript
export function useReviewFilters() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const updateFilter = (key: string, value: string) => {
    // Update URL search params
  };

  return { filters, updateFilter, clearFilters };
}
```

#### **useReviewSubmission** (template-1/hooks/)
```typescript
export function useReviewSubmission() {
  const [isSubmitting, setIsSubmitting] = useState(false);

  const submitReview = async (data: ReviewFormData) => {
    // Handle submission with loading state
  };

  return { submitReview, isSubmitting };
}
```

#### **useReviewAnalytics** (hooks/)
```typescript
export function useReviewAnalytics() {
  const trackReviewView = (reviewId: string) => {
    // Track review impression
  };

  const trackHelpfulClick = (reviewId: string) => {
    // Track helpful interaction
  };

  return { trackReviewView, trackHelpfulClick };
}
```

### Utilities

#### **reviewHelpers.ts** (template-1/utils/)
```typescript
export const calculateAverageRating = (reviews: Review[]) => number;
export const getRatingDistribution = (reviews: Review[]) => Record<number, number>;
export const extractFeaturedTags = (reviews: Review[]) => string[];
export const formatReviewDate = (date: Date) => string;
export const truncateReviewText = (text: string, maxLength: number) => string;
```

---

## 🗄️ Data Layer

### Server Actions (actions.ts)

```typescript
'use server';

export async function getReviewsWithFilters(filters: ReviewFilters) {
  // Fetch and filter reviews from database
}

export async function getRatingStats() {
  // Calculate rating statistics
}

export async function getFeaturedTags() {
  // Extract popular tags from reviews
}

export async function submitReview(data: ReviewFormData) {
  // Validate and save review to database
  // Send notification to admin
}

export async function incrementHelpfulCount(reviewId: string) {
  // Increment helpful counter
}
```

### Types

```typescript
interface Review {
  id: string;
  rating: number;
  comment: string;
  author_name: string;
  author_email?: string;
  verified: boolean;
  source: 'google' | 'tripadvisor' | 'direct';
  photos?: string[];
  helpful_count: number;
  admin_reply?: string;
  created_at: string;
  status: 'pending' | 'published' | 'rejected';
}

interface ReviewFilters {
  rating: 'all' | '5' | '4' | '3' | '2' | '1';
  source: 'all' | 'google' | 'tripadvisor' | 'direct';
  feature: 'all' | 'photo' | 'verified' | 'recent';
  sort: 'newest' | 'highest' | 'helpful';
}

interface RatingStats {
  average: number;
  total: number;
  distribution: Record<number, number>;
}
```

---

## 🎨 Template System Design

### Why Templates?

Following the established pattern from `landing` and `specials` domains:
- **Flexibility** - Easy to switch layouts without code changes
- **Tenant Customization** - Different restaurants can use different layouts
- **A/B Testing** - Test conversion rates across templates
- **Future-Proof** - Add new templates without breaking existing ones

### Template Selection Flow

1. `ReviewsPage` fetches tenant config
2. Config specifies `features.reviews.pageVariant`
3. `ReviewsHost` routes to matching template
4. Template renders with standardized props

### Adding New Templates

1. Create `templates/template-N/` folder
2. Implement with `ReviewsTemplateProps` interface
3. Add components, hooks, utils specific to that template
4. Register in `ReviewsHost.tsx`
5. Update `ReviewsVariant` type

---

## 📱 Mobile-First Considerations

### Touch Targets
- All interactive elements ≥ 44×44pt
- Filter chips with adequate spacing
- Star rating tap areas sized generously

### Layout
- Single column grid on mobile
- Filters collapse to drawer/modal
- Sticky "Write Review" button
- Smooth scroll to top

### Performance
- Lazy load images in reviews
- Infinite scroll with intersection observer
- Optimize rating distribution chart for mobile
- Preload critical fonts

---

## ✅ Implementation Checklist

### Phase 1: Core Structure (Current)
- [x] Create domain folder structure
- [x] Set up `pages/ReviewsPage.tsx`
- [x] Set up `templates/ReviewsHost.tsx`
- [x] Define types in `templates/types.ts`
- [ ] Create proper exports in `index.ts`
- [ ] Fix export error in `src/app/(marketing)/reviews/page.tsx`

### Phase 2: Template-1 Components
- [ ] Implement `RatingsSummary` component
- [ ] Implement `FilterBar` component
- [ ] Implement `ReviewsGrid` component
- [ ] Implement `ReviewCard` component
- [ ] Add responsive layouts

### Phase 3: Interactivity
- [ ] Implement `useReviewFilters` hook
- [ ] Implement `useReviewSubmission` hook
- [ ] Connect filter updates to URL
- [ ] Handle form validation

### Phase 4: Server Actions
- [ ] Implement `getReviewsWithFilters`
- [ ] Implement `getRatingStats`
- [ ] Implement `submitReview`
- [ ] Implement `incrementHelpfulCount`
- [ ] Add error handling

### Phase 5: Polish
- [ ] Add loading states
- [ ] Add empty states
- [ ] Add success/error toasts
- [ ] Optimize performance
- [ ] Add analytics tracking
- [ ] Mobile testing

---

## 🚀 Migration Plan

### Current State Issues
1. `index.tsx` contains old page implementation
2. `index.ts` exports are correct but page needs updating
3. Template structure exists but needs components moved

### Migration Steps

1. **Move components to template-1**
   - Move `/app/(marketing)/reviews/components/*` → `templates/template-1/components/`
   - Update imports in moved components

2. **Update index.tsx**
   - Either delete (use pages/ReviewsPage.tsx) OR
   - Refactor to use template system

3. **Consolidate actions**
   - Keep server actions in domain root `actions.ts`
   - Import into components as needed

4. **Fix exports**
   - Ensure `index.ts` correctly exports `ReviewsPage`
   - Update app route to import from domain

---

## 🔗 Integration Points

### Database
- `reviews` table for review data
- `review_photos` table for images
- `review_helpful` table for helpful votes

### Authentication
- Clerk for user identification
- User metadata for reviewer name
- Email verification for verified badge

### File Storage
- Cloudinary for review photos
- Thumbnail generation on upload

### Notifications
- Email to admin on new review
- Email to reviewer on admin reply

---

## 📊 Success Metrics

### Technical
- LCP < 2.5s on reviews page
- INP < 200ms for filter interactions
- CLS < 0.1 on page load

### Business
- 5%+ review submission rate
- Average rating above 4.0
- 80%+ helpful vote engagement

---

## 🔮 Future Enhancements

### Template-2: Masonry Layout
- Pinterest-style card layout
- Photo-first reviews prominent
- Infinite scroll optimization

### Template-3: Carousel Cards
- Swipeable review cards
- Featured review highlight
- Mobile-optimized navigation

### Admin Features
- Review moderation dashboard
- Reply to reviews
- Analytics and insights
- Export reviews data

### Advanced Features
- Photo gallery lightbox
- Review sentiment analysis
- Auto-translate reviews
- Review rewards program

---

## 📚 References

- User Needs: `docs/research/user-needs-by-page.md`
- Page Blueprints: `docs/ux/page-blueprints.md`
- Domain Pattern: `src/domains/specials/README.md`
- Web Vitals: Core Web Vitals documentation

---

**Next Steps:**
1. Review and approve this BMAD plan
2. Fix immediate export error
3. Begin Phase 2: Template-1 components
4. Test on mobile devices
5. Deploy and monitor metrics
